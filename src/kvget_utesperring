#! /bin/sh

## Script to update metadata tables in Kvalobs.

set -a  # export variables to the environment of subsequent commands
set -e  # Exit if a simple shell command fails
#set -x  # for debugging, remove later

PSQL=psql
PGDATABASE=kvalobs
PGUSER=kvalobs
: ${PGUSER:=$USER}
: ${PGPORT:=5432}
: ${PGHOST:=localhost}

# echo "mypghost $PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASSWORD"

# Create a .pgpass file to use so we do not need to give the
# password for each call to psql
# It works by creating a temporary file. Get a filehandle (3) to the file
# and delete it. Set the PGPASSFILE environment variable to /proc/PID/fd/3
# write the credentials to the file. The file is automaticly removed on exit.

rm -f "$HOME/.pgpass.kvget.*"
PGPASSFILE=$(mktemp $HOME/.pgpass.kvget.XXXXXXX)
chmod 0600 $PGPASSFILE
exec 3>$PGPASSFILE
rm $PGPASSFILE
PGPASSFILE="/proc/$$/fd/3"
# echo "PGPASSFILE: $PGPASSFILE"

if [ -f $HOME/etc/kvdblist.conf ]; then
    echo "The file $HOME/etc/kvdblist.conf exists"
    KVDBLIST=`cat $HOME/etc/kvdblist.conf`
    for KVDB in $KVDBLIST
    do
        # echo $KVDB
        PGHOST=$KVDB
	if [ -f  $HOME/.pgpass ]; then
	    ## PGPASSWORD=`cat $HOME/.pgpass | grep $KVDB | cut -f5 -d:`
	    # KVPGPASS=`cat $HOME/.pgpass | grep $KVDB`
	    # echo $KVPGPASS 1>&3
            cat $HOME/.pgpass | grep $KVDB 1>&3
	else
	    echo "The file $HOME/.pgpass does not exist"
            read -s -p "dbpassword: " PGPASSWORD
	    ## echo "$PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASSWORD"
            echo "$PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASSWORD" 1>&3
	fi
	
        VARn=`$PSQL --quiet --tuples-only -c 'select pg_is_in_recovery()'`
        VAR=`echo $VARn | tr -d '\n'`
        # echo -e "length(VAR)==$(echo -ne "${VAR}" | wc -m)"
        #if [ "z$VAR" != "z" ] && [ $VAR == "f" ]; then
        if [ "z$VAR" = "zf" ]; then
	    # echo "selected database is $KVDB" 
	    break 
        fi
    done
    # echo "mykvdb=$KVDB"    
else
    echo "The file $HOME/etc/kvdblist.conf does not exist"
    read -s -p "dbpassword ($PGHOST): " PGPASSWORD
    echo "$PGHOST:$PGPORT:$PGDATABASE:$PGUSER:$PGPASSWORD" 1>&3
fi

METAGET=/var/lib/kvalobs

KRO="kro"
if [ -f $HOME/.kro  ]; then
    KRO=`cat $HOME/.kro`
fi


if [ -n "$1" ]; then
   METAGET=$PWD
   echo "argumentet er $1"
   # tar xvvjf $1
else
    DUMPDIR="$METAGET/dumpdir"
    mkdir -p -m700 $DUMPDIR
    mkdir -p -m700 "$METAGET/utesperring"
    #cd "$METAGET/dumpdir"
    LOGDIR=$HOME/log/utesperring
    mkdir -p $LOGDIR

 for FILE in utesperring.sql utesperring_update.sql
 do
    wget -O - http://$KRO/$FILE > $DUMPDIR/$FILE
    if ! [ -s $DUMPDIR/$FILE ]; then
       echo "Filen $DUMPDIR/$FILE er tom" > $LOGDIR/$FILE.log
       exit 1
    fi  

    echo "$DUMPDIR/$FILE"
    echo "$METAGET/utesperring/$FILE"

    if ! diff -q  $DUMPDIR/$FILE  $METAGET/utesperring/$FILE
    then
       if [ -f $METAGET/utesperring/$FILE  ]; then
            mv -uv $METAGET/utesperring/$FILE $METAGET/utesperring/$FILE.old
       fi 
       cp -pv $DUMPDIR/$FILE $METAGET/utesperring/$FILE
       $PSQL -f $METAGET/utesperring/$FILE
    fi
  done
fi


